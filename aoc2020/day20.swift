//
//  day20.swift
//  aoc2020
//
//  Created by 4 on 12/19/20.
//

import Foundation

func day20() {
    
    let list = sd(20)
    
    var tiles: [Int: [String]] = [:]
    var bords: [Int: [String]] = [:]
    var current = 0
    
    for i in list {
        if i != "" {
            if i.first(1) == "T" {
                current = Int(i.sansFirst(5).sansLast(1))!
                tiles[current] = []
            } else if i != "" {
                tiles[current]!.append(i)
            }
        }
    }
    
    for t in tiles {
        let left = String(t.value.map { $0.first! })
        let right = String(t.value.map { $0.last! })
        bords[t.key] = [t.value.first!, t.value.last!, left, right]
    }
    
    var a1 = 1
    for b1 in bords {
        var co = 0
        for b2 in bords {
            if b1.key != b2.key {
                for side in b1.value {
                    if b2.value.contains(side) || b2.value.contains(String(side.reversed())) {
                        co += 1
                    }
                }
            }
        }
        if co == 2 { a1 *= b1.key }
    }
    
    func trim(_ tile: [String]) -> [String] {
        let newT: [String] = tile.slice(start: 1, len: 8)
        var nnT: [String] = []
        for line in newT {
            nnT.append(String(line.slice(start: 1, len: 8)))
        }
        return nnT
    }
    
    func rotate(_ tile: [String], _ n: Int) -> [String] {
        if n == 0 { return tile }
        else if n == 2 { return tile.reversed().map({ String($0.reversed()) }) }
        else {
            var newT: [String] = Array(tile.last!).map { String($0) }
            for i in 2...(tile.count) {
                for j in 0..<newT.count {
                    newT[j].append(tile[tile.count-i][j])
                }
            }
            if n == 3 { return newT.reversed().map({ String($0.reversed()) }) }
            return newT
        }
    }
    
    var fit = [2111]
    var next: String = String(bords[2111]![0].reversed())
    var next2: String = String(bords[2111]![3].reversed())
    var pic: [String] = trim(rotate(tiles[2111]!,1))
    var old = 0
    while fit.count < 144 {
        if fit.count == old {
            print("failure", fit.count, fit.last!, next)
            break
        } else { old = fit.count }
        for b in bords {
            if !fit.contains(b.key) {
                if b.value.contains(next) || b.value.contains(String(next.reversed())) {
                    var new = tiles[b.key]!
                    let newLine = fit.count % 12 == 0
                    lop: for _ in stride(from: 0, to: 2, by: 1) {
                        for _ in stride(from: 0, to: 4, by: 1) {
                            if new[0] == next {
                                if newLine {
                                    pic.append(contentsOf: trim(new))
                                    fit.append(b.key)
                                    next = String(new.map({ $0.last! }).reversed())
                                    next2 = new.last!
                                } else {
                                    new = rotate(new, 3)
                                    let s = trim(new)
                                    for i in 1...8 {
                                        pic[pic.count-i].append(s[8-i])
                                    }
                                    fit.append(b.key)
                                    if fit.count % 12 == 0 {
                                        next = next2
                                    } else {
                                        next = String(new.map({ $0.last! }).reversed())
                                    }
                                }
                                break lop
                            }
                            new = rotate(new, 1)
                        }
                        new = new.reversed()
                    }
                }
            }
        }
    }
    
    var a2 = 0
    
    for lin in pic {
        for c in lin {
            if c == "#" {
                a2 += 1
            }
        }
    }
    
    let monster = ["                  # ",
                   "#    ##    ##    ###",
                   " #  #  #  #  #  #   "]
    let hashNum = monster.reduce(0) { n,s in n + s.repeats(of: "#") }

    for _ in stride(from: 0, to: 2, by: 1) {
        for _ in stride(from: 0, to: 4, by: 1) {
            for y in stride(from: 0, to: pic.count-2, by: 1) {
                for x in stride(from: 0, to: pic[0].count-19, by: 1) {
                    var there = true
                    li: for dy in stride(from: 0, to: 3, by: 1) {
                        for dx in stride(from: 0, to: 20, by: 1) {
                            if monster[dy][dx] == "#" {
                                if pic[y+dy][x+dx] != "#" {
                                    there = false
                                    break li
                                }
                            }
                        }
                    }
                    if there {
                        a2 -= hashNum
                    }
                }
            }
            pic = rotate(pic, 1)
        }
        pic = Array(pic.reversed())
    }
    
    print("20:", a1, a2)
}

//.............#...#...#...#......#.#...............#...#........#...#....#....###..#.##...#.#....
//..#...#.....#......#...#.......#....#.#......#..#.................##...##........#...####......#
//.....................#.#...#.........##...#..##..#......#.......#.....####.#.###.#..#.....##....
//....#..#....#..###..........#.............#...##....##........#...##.##......#..#...............
//#.........#........##.............#..#...#.###..#..#.#....#.....................##.....#.....#..
//.##.....#....#...##........#..#..#.#..#..#.........#.#........#........##.......#..#.....#.###..
//#....................#........#...........#.#.#.......#.#......#....#.##......#...#.##...#.....#
//#......##..#.......#..#....#...#.#.......#..#.......#...........##....##......###..##...........
//.....#..#...#.....##....................................#.....##......#...##.#....##.#.....##..#
//.#...............#.....#.#...........#.#.##......#.........#....#....##.#..#..###.....##........
//##..............#..............#.##...#..#..##.#....#..#..#.#...........####.#.#.......#.#......
//...........##..#.#...#.....##.....#.#.....##...##.#.......#.......#.....#.....##......#.........
//...........#.#..#................#####.#....#...##..#.#.#......#.#.#...#...#..#.#..#.#..#..#....
//#........##...#.........#........#....#........#.##..#..#.........###......#.#..#..###..#.#..#.#
//..........##.##.......#...#...#............#......#..#.#......#....#.##..#.......#.##..##.....#.
//.#.#.......##.........#....................##..#.....#............#..#...#..##.#...#....#....#..
//..##.................#.##.................#...#....#......#.........#.#...##..#.........#....##.
//..#.....#..##......#..#..##..#.....#........#...#...............#..##.......#...#...#....#......
//.#.#....#.......#....#...#....................###.#.............#.##......#........#..#....#....
//#.#....#...##.#.....###...#.##...###...#.##......#............#....#...#........#.....##......#.
//#..#....###.......#...##...##.#.##.#..#....#.....#..#........#......#....#.#.....#.....#.......#
//.............#.......#..#..................##...........###.#..#...........#.##....#..........#.
//..#.......#..........#...#........#........................#......#.##.....#.........#..#.#..#..
//##.....##....###......#........##......#..#.#.#...#...........##..####........#.##.#..#........#
//..#........#..#.........#...#......................#....#.......##.#..#...#....#..##.#...###....
//......###....##...#.............##.......#..#..#......#.#..#.....#.......#..######.....#..#.....
//.#.#......#..##........#........#...#.....###......#.......#.####.##......####........#.........
//.........#...................#..#.....##..................#.#.##.........#.#...........##.......
//...........#.#..##.....#.#.#.#......#..#.#......................#...........#.#...#..#.#........
//#.........###..#..#...#....#...#...###..........##....#......#......####.#.#....#..#..#..#......
//..#.......#.......#...................#..#..#.....#..#..#.....#.#..#..#...#.........#.......#..#
//..........#....#...........#..........##..........##..#.....#......##....##.#..#.#..#......#....
//.#........##.#..###.......#...........#..##......#.#......#....#.#.#..#....#..###....#...##.....
//...#.....#......#........#.............##....#..........#.#....................#.....##.........
//.....#.#............###.#....#.#.......#..#...#.#..###......#............#....#...#.....#.......
//.....#........#....#..###.......#....#......#.#.#..#..#.....#.....#.#..#....#.#.....#....#......
//...#........#.#....#.#..#................##..#....##.....#...#.....#..###.......#.......#....#..
//..##.........#.....#....#..##...........##...###.....#.##.##.....##.##.........#...........##...
//...........#....#.##.#....#............##...#....#.......#...........#....#....#.....#..#.....#.
//.#..#...........#.##.#....#...#.##......#.#.....#.#.......#..........#..#.............##........
//........#.......##....##...#.#.......#....#..#.#...........#.##...........#.####..#...#........#
//............##...##..#...#..#....##.#......#.#..........###....#...#.....#.##.#......##..#.###..
//..#.......###...........#.#..#..###.#..#.......#...#.....#......#....##........#.##.#.#........#
//......#.#..#.#.#...#.....#..#...#..#..#.......##..#...#...#...#..#..#..#...#....##...#..........
//...............#.#..#.#.#...........#.#.##..#..##.......................#.##.#............#.#...
//.....#...#.......##...##......#..##.#..##....##.............#.##........#..##.....#...#....#..#.
//###...#.....##.##.##..#.#..##...#.....#..#...#.....#.#.#.......##....###.....#...#.#.#....#.#...
//.....#...###...#...##.......#....#...##.......##......#......#.#.#..#.##............#......#.#..
//...........#.#......#.....##......#.....#.#.#............###....#...............#.##...#....#...
//#..#....#..#.##..#.....#...........#....#..#..#..#.#.#........##.......#...#.....#.#...#........
//.........##....#.............##.#..#........##....#.....###...#.#.#.#.......#............#...#..
//....###..#..#.#.#..#.#.##..#.##.#...........#.........#....#..............#...#..#...#..........
//.#.#.#..#........#....#.#..#.#..#....##....#..................#......#......#.........##.....#..
//..###.......#...#....##.##...#.......###......#...####.##...#................#...#......###..#..
//.....#......#....#.###...#.#.##..................#..#..#.............#.#..#.....................
//............................#..........#.#...#....#.#.............#....#..........#.#..........#
//..###...#.......#...#.........#.......................................##..##.......##.....#.#...
//.....#...#.........#............##..#...##...#.#.##.#..............#..##.......#..#.##.....##...
//.#.#.............#.......#...#..#....#............#.......#.#...##............#......#...#......
//....#....#.#....##......#..#..#.#....##...#.#..#....#.....#...##..#.....#...#..#.....#....#..#..
//.#...............#......###....###..#..###.#...##...#.......#.#.......#.....#..........#.....#..
//#...#..#........##.#.....#.........#....#............#...........#.............#...........#....
//..............##.........#...........#..#.#..#.........#..#..##...#.....##..#..#........#...##..
//..#..##..#..##..........##........#..#...........#.#.......#.........#.##..####..........#.....#
//............#.............##.....#........#.#.#..##.......##....#......................#....#.##
//...#.#.#.#..#..........#.......#..#.##.......#.#......#.##..#.##......#.#............#........#.
//..#..#...###....#..............##..#####...#...##.......#....##..##......#...#......#.......#...
//.......#......#.........#........#.#....#.....#.##.####......#......#...#..#.....#..#...#..#....
//#..#.#....#........#..#..#........#...#.....#.......#..#........#..............#.#....#.........
//..#.....#.................##.#....###....#...#.#......##........##.##.#..##..............#..#...
//....#..#...........#....###...##...#....#.#...............##.#....##.#............#.#...#.#.#...
//.....#.............#....#.......#..#.......#..#.#.#........##.....#........................#....
//#..##...............#........#.##......#................#.#..#...##..##..#..................##..
//...#..............#.#....#..##...#.....#..#..............#.#..#.#.#.##..#..........#........#.##
//...#..#...#........#....#...#......#.#....##......#.................###..........##....#..#...#.
//......###.#..#...##...##.#.##..#...............##.....#....#...........##..#..#.#.###.#......#..
//##..#...#.###...##.#..###.#..#........#...#....#.....#.....#...#..#.#....##.##.#...#...#.#...#.#
//......#....#....#..#.........................#..#..#..#..#.....#...........##.#...###.....#.#...
//..........#...........#...#........#...#........#......#...........#.................#....#..#..
//.#.........#.................#.........#.#..#.....##...#...#...#...........##........#...#.##...
//............#......##..##........##...#........#.####.#.#..#..##.#..#........#..##...##.......#.
//..#...........#..#..#....#..#..##............#..#.###..#.##....##..#.....##......#..#.##.#...#..
//.....#..#.....##....#....###...#..#.#...........#..#.......#..#..#.........................#....
//..##..............#....#.....###.....##....##.....#.#....#.....##.......................#.#..#..
//....................##..#..#..#.............#..#..#.....#....#..#.........#.....................
//...#...........#.#.####.........##....#...##....##.#.............#....................#....#...#
//..........#....#..#...#.....#.....#..#.#...##..#..###.#.#.##.##.##...##....#..#..#........#.....
//.#.......#...#......#....#.#...........#...#..#..#...#..##....##.#..#...###....#.....#.....#.#..
//.....#.#.....#.#.....#.#.............#..............##.......#..##.#..#...#...............#.....
//....#...#....###...#.###.#.....#..#..#......#........#............#....#....#.......#...........
//....#........#...##.....#...#..#.....#..#........#.#......#..#...#.....#....#.###.#.#.........#.
//..#...........#..........#....#..##..#.....#..##......#....##..........#.........#..............
//........#.........................##..#........##....##.......#..#...#......#...#..#...........#
//.#....#.....#........#.....#.........##...#..###.#.##..##.#.....#.......#..#.....#.#....#.#.....
//..#...........#.......#.#.#.....#...#......#.....#.###....#...#.......#.......#...#........#....
//....#.#...........#....#....#.......#..............#....#..#..#.....##...#...#...........#...#..


//##.#....#..#.....#...#.....#...##.#......#..#.....#...#............#..........##..#.##..........
//..#................#...#......#.....#.#...#.#.#.#.......#......#..##...#......#..#...###.#.....#
//..#...#.#....#.......#.#...#..#......##..#.......#............#.#.....###........#..#....#.###..
//..........#.....##.......................#.###......##....#.......##.##.........#............#..
//....#.......#..#...##.......#.....#..#....#...###..#.#........#..............#..##.....#........
//.................##........#.....#.#..#...#..##....#.#..#..............###.#.####..#......##....
//......#.....#........#.........#.............#........#.............#.###.........#.##..#......#
//#...#........#.....#..#..#.......#..................#..........###....###....####..##....#.#....
//.....#.....##.....##.......................##..#......................#..#..##.#..##.#..#....#..
//.#........##.##..#.....#..#...#......#.#...#.....#............#.#....##..#......#.....###.....#.
//##.......##...#.#.......#........##...#........#....#..##..................#.#.........##.#..#.#
//...........#.#...#...#............#.#.......#...#.#.....#......#..#........#..#.......#.#..#....
//...........##..##..........##....#####.#..##...###..#.#...#......#.#...##.....###..#.#..........
//#..............................#.#....#..#..##.#.##..#....#.#.....###...####.#.##..###...#......
//......................#..#...............##.......#..#.#...#.......#.##.#..#..##.#.##..#........
//.#.#....#...#.........#..............................#..#.....##..#..#....##.#.....#.......##..#
//..##....#....###.....#.#.......#..........#.#.#....#..........##....#.#.......#................#
//..#.......#........#..#..#.........#............#..........#....#..##......#....#...#...#.#..#..
//.#.#.........#..#....#..#..................##...#.#.....###.#..##.##.......#.##....#..#.......#.
//#.#....####.........###....##.#..###...#...#.....#...........#.....#...#.#.#....#.....##.......#
//#..#.......##.#...#...##..#.##..##.#..#..##......#..#.........#.....#............#.....#......#.
//........#............#...#....................##..........................#........#.......#....
//..#.....#..##........#...##..#....#.........#.....................#.##......#........#...#......
//##.....#..............#.#.......#......#..#...#...#.......#.......####....##..#.##.#..#.#....##.
//..#.......#....#...........#.......................#........#...##.#..#..##.#..#..##.#.....#....
//......##..#.......#.............##.......#..#.........#.#.....#..#........#.....##.....#....#..#
//.#.#......###..#.......#...#...##...#..............#.........#..#.##.....#.#..........#..#......
//...........#.#...........#.#.#..#.....##.#..................................#.#........#........
//.........#......##.....#.....#......#..#..................#.#.###........#.#......#..#.##.......
//#.........#..##...#...#............###....###...##....#....#.###....####..####..#..#..#.........
//..#.....#....##...#...................#..#..#..#..#..#..#..#....#..#..#..#..####....#.....#.....
//...........#..#.........#...#.........##..........##..#.#..........##.....#....#.#..#....###....
//.#..............###.......#...#.......#.#.#......#.#......#......#.#..#.#.......#....#..........
//...#.......#....#.........#............##...#............#................#....#.....##.#.....#.
//.....#.#.....#......###.#..##..........###...####..###..#.##...................#..#........##...
//.....#......#.#....#..###.......#....#...##..#..#..#..#..#...#....#.#..##...........#...#....#..
//...#..........#....#.#..#...................#.#...##........#......#..##....#.#.#........#......
//..##...............#....#....#.#..........#...#......#.#....#....##.##...#....#.........#.......
//.........#......#.##.#...#.............##....#...#......#.#..........#.........#.....#..........
//.#..#.....##.#..#.##.#....#.....##.......##.....#.#.......#....#.....#.....#..##......##.##.....
//.........###...###....##....#........#........##.............#.#..................#...#....#.#..
//............##.#.##..#..#..##....##.#....#...#.................#...#.........#.......##...#.#...
//..#......#....................#.###.#..##....##....#........#.###....##.#..##....##.#.#....#..#.
//......#........#...#....#.......#..#..#.##..#..#..#...#..........#..#..##.##.#..##...#....#.#...
//........#..#.#.#.#..#.#..#..#.......#.#.......###.........#...#............#....................
//.....#....###....##...###.#..#...##.#..#.......#.........#.....................#..#...#........#
//###...#.....##..#.##..#..#..#...#.....#....#.#.....#.#.####....##....###.#.##.#..#.#.#...#.###..
//.....#..#..........##......#.#...#...##...#..#.#......#....#.##..#..#.##..#.####....#..........#
//....................#.......#.....#......#...#..................#...............#.##...#.......#
//#..#........#....#.....#.#.#.##....#.............#.#.#.................#..#......#.#...#........
//............#...........##...#..#..#..........#...#.....#...#...#.#.#........#..........###..#..
//....###.#.......#..#.#.##..#.#..#..........#..........#.......#.............#....#...#.......#..
//.#.#.#...#..#.#..#....#.#..#.##.#....##.....#..............#.........#....#...#.......##........
//..###....##....##....##......##......###....##....####.####...#.............#....#.......#...#..
//.....#..#..#.##..#.###..................#..#..#..#..#..#......##.....#.#...#....................
//...........#.#............##...........##.#.#.....#.#....###......#....#..........#.#.......#...
//..###....#..##..#...#...##.................................#..........###..####....##....#.....#
//.....#........##...#.....#......##..#...#.#..#...##.#.....#..##....#..####..#..#..#.##..#...##..
//.#.#.............#.......#......#....#..#.........#.............##.............#.....#.....#....
//....#...........##......###....##....##.##.#...#....#.......#.#...#.........#........#.......#..
//.#.......#.#.....#......#..#..#.##..#..#..#.#..##...#.....#...##......#.#...#..#.......#..#..#..
//#...#..#........##.#.....#...#.....#.................#....#.#....#............#..........#......
//.........#...........................#..##...#.#.......#..........#............#...........##...
//..#..##.#.....................#...#..#...........#.#.................#.#..##..............#.#...
//........................#........#.........#..#..##........##...#......................#...#....
//...#.#.#...............####...##..#.##..#.#...........#...##.#........#..............#..#.#.#...
//..#..#..#.......#.........##.#..#..#####.#...#.##................##......##.........#....#..#...
//.......#..#..............#.......#.#........#...##.####.............#..........#.#..#...........
//#..#.#........#....#..#.#.........#...#.#.....#.....#..#.....#..#.......#..#.....#....#.#..#....
//..#......###...................#..###......#...#......###....##.##.##.#..#...#..............#...
//....#..#.#..#......#...........#...#.........#.#........##..#.##..##.#..#.........#.#.........#.
//.....#......#......#......##....#..#......#.#.#.#.#.......##......#.........................#.##
//#..##......#........#........#..#......#.#..#..............#...#.##..##....##............#.##...
//...#......#.......#.#.....#......#.....#........................#.#.##.............#......#..#..
//...#..#....#.......#...............#.#.......#....#......#.....#....###....##.#..##....#..#.#...
//......###.###....##...###.#..#............#....##.....#....#...#.......#.##.##.##.###.#..#...#.#
//##..#...#.#..#..##.#..##.#.##..#......#........#.....#.....#......#.#...#..#..#....#...#.....#..
//......#...#.....#..#....#...#.............##....#..#..#...........................###.....#...#.
//......................#..#..##.....#...#..#.....#......#.#.#..#....#....#............#......#.##
//.#...........................#.#.......#..........##...##.#..#...........#...........#......##..
//.........#...#.....##..#.#.#.....##...#....#..#..####.#.##....##.#..#...###....###...##....#.#..
//..#.......#....#.#..#.......#...#..........##..##.###..##.##.##.#..#.......#..#..#..#.##..#.....
//.....#.........#....#.............#.#.....##....#..#.............#.........................#...#
//..##..............#....##..#..#......##.....#..#..#.#...#....#..#.........#.....................
//....................##.......###...........##.....#......#.....##.......................#.#..#..
//...#....#.....##.#.####..###...###....#.........##.#.......#..#..#....................#....#....
//..............#...#...#..#..#..#..#..#.#.....#....###.#..##....###...##..##......#.......#...#..
//.#..........#.......#...#..............#.......#.#...#..#..#..##.#..#........#.......#........#.
//.....#.#.............#.#....#........#..............##..#..#..#.##.#..#..#...#...........#...#..
//....#.........#....#.####.#.......#..#.....#.........#....#...#...#....#......#.....#......#....
//....#.......#....##........#.........#....#..###.#.#....#.#......#.....##..#....#.#.#...#.#.....
//..#.....#........................##..#.........#......#.......#........#....#....#.............#
//..............#..........#....#...##..#....#..###....##....##....#...#..........#..#............
//.#....#......#.......#..#...#..#.....##.#........#.##..#..#..#..#...........#.##.#.#..........#.
//..#.....#....###......#..#.....##...#.......#....#.###................#.....#.....#.............
//....#.#......#.#..#....#............#..............#.........#......##....#...............#.....
